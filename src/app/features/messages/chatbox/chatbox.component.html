<main class="relative h-full flex flex-col py-2">
  <hlm-toaster />
  <brn-separator decorative hlmSeparator />
  <header class="flex w-full items-start py-2 px-4 md:px-0 justify-between">
    <div class="flex items-center gap-x-2">
      <hlm-avatar variant="medium">
        <img
          [src]="imageUrl() ?? '/icons/avatar.svg'"
          alt="pfp"
          hlmAvatarImage
        />
      </hlm-avatar>
      <h1 class="font-medium text-2xl">
        @if(conversation()) { 
          @for(participant of conversation()?.participants; let i = $index; track i) {
            @if(this.currentUser()?._id !== participant._id) { 
              {{ participant.first_name + " " + participant.last_name }}
            } 
            @if($index + 1 < conversation()?.participants!.length && this.currentUser()?._id !== participant._id) 
            {
              ,
            }
           }
          }
      </h1>
    </div>
  </header>

  <brn-separator decorative hlmSeparator />
  @if(hasMoreMessages() && isLoading()) {
    <div class="flex justify-center py-2 border-b border-input">
      <p class="text-sm text-slate-400">Loading older messages...</p>
    </div>
  }
  <section
    class="h-full overflow-y-scroll flex-1 flex flex-col-reverse"
    appIntersectionObserver
    [options]="{ rootMargin: '0px', threshold: 0.1 }"
    (visible)="onChatTopVisible()"
  >
    <div
      id="chat-messages"
      class="flex flex-col-reverse p-4 space-y-4 space-y-reverse"
    >
      @if(messages().length > 0) { 
        @for(message of messages(); track message._id) {
        <ng-container>
          <div class="flex-1 mt-2">
            <div
              hlmCardDescription
              class="text-xs text-center mt-1 opacity-70 mb-4"
            >
              {{ getMessageTime($index) }}
            </div>
            <div
              class="flex items-center mb-0"
              [ngClass]="{ 'justify-end': isCurrentUserMessage(message) }"
            >
              <div class="flex flex-col">
                @if(conversation()?.is_group && !isCurrentUserMessage(message)){
                <span class="text-gray-500">
                  {{ message.sender.username }}
                </span>
                }
                <div class="flex items-center justify-start">
                  @if(!isCurrentUserMessage(message)){
                  <hlm-avatar variant="small" class="min-w-fit mr-1.5">
                    <img
                      src="/icons/avatar.svg"
                      [alt]="message.sender.username"
                      hlmAvatarImage
                    />
                    <span class="bg-[#FD005B] text-white" hlmAvatarFallback
                      >RG</span
                    >
                  </hlm-avatar>
                  }
                  <hlm-card hlmCard>
                    <div
                      class="py-1 px-3 text-ellipsis max-w-xs md:max-w-sm lg:max-w-md"
                    >
                      <p>{{ message.content }}</p>
                    </div>
                  </hlm-card>
                </div>
              </div>
            </div>
            @if(isCurrentUserMessage(message) && $index === 0){
              <div hlmCardDescription class="text-xs text-end mt-1 opacity-70">
                <span>{{ message.status | titlecase }}</span>
              </div>
            }
          </div>
        </ng-container>
        } 
      } @else {
        @if(isLoading()) {
          <div class="mx-auto">
            <hlm-spinner />
          </div>
        } 
        @else {
          <ng-container>
            <div class="flex justify-center h-full items-center">
              <p class="text-slate-400">No messages yet. Start the conversation!</p>
            </div>
          </ng-container>
        } 
      }
    </div>
  </section>

  <brn-separator decorative hlmSeparator />
  <footer>
    <!-- Message Input -->
    <div class="p-2 flex justify-center items-center gap-x-4">
      <input
        id="sender-input"
        hlmInput
        class="w-full"
        placeholder="Type a message..."
        [formControl]="messageControl"
        (keydown.enter)="$event.preventDefault(); sendMessage()"
      />
      <button hlmBtn (click)="sendMessage()" class="cursor-pointer">
        Send
      </button>
    </div>
  </footer>
</main>
